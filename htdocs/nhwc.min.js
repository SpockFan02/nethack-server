function refresh(){socket.send("R")}function handle_keypress(a){return a.ctrlKey?socket.send("K"+String.fromCharCode(a.which-96)):socket.send("K"+String.fromCharCode(a.which)),a.preventDefault(),!1}function main(){conn_state=1,document.getElementById("connect-button").innerHTML="Disconnect",socket.onmessage=function(a){for(var b=0;b<a.data.length;b++)vt100_parse(a.data[b])},socket.onclose=function(a){document.getElementById("connect-button").innerHTML="Connect",conn_state=0,setColor(0,!1),ctx.fillRect(0,0,t_width,t_height)},document.addEventListener("keypress",handle_keypress),setInterval(refresh,10)}function connect(){conn_state?socket.close():(socket=new WebSocket("ws://mc.firewiz.net/"),socket.onopen=main)}function step_term(){vt100_parse(tty_queue[0]),tty_queue=tty_queue.substr(1)}function log(a){console.log(a)}function move_curs(a,b){var c=cx,d=cy;cx=a,cy=b,cx>79&&(cx=79),cy>24&&(cy=24),cx<0&&(cx=0),cy<0&&(cy=0),update_term(c,d),update_term(cx,cy)}function setColor(a,b){bold&&b?ctx.fillStyle=ctx.strokeStyle=colors_bold[a]:ctx.fillStyle=ctx.strokeStyle=colors[a]}function vt100_csi_dispatch(a){var b=vt100_param.split(";");if("A"==a)0!=b?move_curs(cx,cy-b[0]):move_curs(cx,cy-1);else if("C"==a)0!=b?move_curs(cx+b[0],cy):move_curs(cx+1,cy);else if("H"==a)b.length>1?move_curs(b[1]-1,b[0]-1):move_curs(0,0);else if("J"==a)0==b[0]||1==b[0]||2==b[0]&&(setColor(bg,!1),ctx.fillRect(0,0,t_width,t_height),setColor(fg,!0),tty.fill([" ",0,7],0,2e3));else if("K"==a)setColor(bg,!1),ctx.fillRect(cx*c_width,cy*c_height,t_width,c_height),setColor(fg,!0),tty.fill([" ",0,7],80*cy+cx,80*(cy+1));else if("d"==a)move_curs(cx,b[0]-1);else if("h"==a)log("Set mode "+b[0]);else if("l"==a)log("Reset mode "+b[0]);else if("m"==a)if(b.length>0)for(var c=0;c<b.length;c++)b[c]>=30&&b[c]<=39?fg=b[c]-30:b[c]>=40&&b[c]<=49?bg=b[c]-40:""==b[c]||0==b[c]?(fg=7,bg=0,bold=0,rev=0):1==b[c]?bold=1:7==b[c]?rev=1:log("Unknown style "+b[c]);else fg=7,bg=0,rev=0,bold=0;else log("Unknown CSI "+a+" ("+vt100_ic+" # "+vt100_param+")")}function vt100_parse(a){if("ground"==vt100_state)if("\n"==a)move_curs(0,cy+1);else if("\r"==a)move_curs(0,cy);else if(""==a)vt100_state="escape";else if("\b"==a)move_curs(cx-1,cy);else{addch(cx,cy,a);var b=cx,c=cy;cx++,cx>80&&(cx=0,cy++,cy>24&&(cy=0)),update_term(b,c),update_term(cx,cy)}else"escape"==vt100_state?(vt100_param=vt100_ic="",vt100_state="["==a?"csi_entry":a.match(/[%(]/)?"esc_intermediate":"ground"):"esc_intermediate"==vt100_state?vt100_state="ground":"csi_entry"==vt100_state?a.match(/[0-9;]/)?(vt100_param+=a,vt100_state="csi_param"):a.match(/[ -/]/)?(vt100_ic+=a,vt100_state="csi_intermediate"):a.match(/[<=>?]/)?(vt100_ic+=a,vt100_state="csi_param"):":"==a?vt100_state="csi_ignore":a.match(/[@-~]/)?(vt100_csi_dispatch(a),vt100_state="ground"):vt100_state="ground":"csi_intermediate"==vt100_state?a.match(/[ -/]/)?vt100_ic+=a:a.match(/[@-~]/)?(vt100_csi_dispatch(a),vt100_state="ground"):vt100_state="ground":"csi_param"==vt100_state?a.match(/[0-9;]/)?vt100_param+=a:a.match(/[:<-?]/)?vt100_state="csi_ignore":a.match(/[@-~]/)?(vt100_csi_dispatch(a),vt100_state="ground"):vt100_state="ground":"csi_ignore"==vt100_state?a.match(/[@-~]/)&&(vt100_state="ground"):vt100_state="ground"}function update_term(a,b){if(!(a<0||a>79||b<0||b>79)){var c=tty[a+80*b];setColor(c[1],!1),ctx.fillRect(a*c_width,b*c_height,c_width,c_height),setColor(c[2],!0),ctx.fillText(c[0],a*c_width,b*c_height+.75*c_height),a===cx&&b===cy&&ctx.fillRect(a*c_width,b*c_height+.8*c_height,c_width,1)}}function addch(a,b,c){rev?tty[a+80*b]=[c,fg,bg]:tty[a+80*b]=[c,bg,fg],update_term(a,b)}function tty_init(){var a=document.getElementById("term");ctx=a.getContext("2d"),ctx.font="16px monospace",setColor(bg),ctx.fillRect(0,0,t_width,t_height),setColor(fg);for(var b=0;b<2e3;b++)tty[b]=[" ",0,7]}var socket,cx=0,cy=0,ctx,tty_queue="",conn_state=0,c_width=10,c_height=16,t_width=80*c_width,t_height=25*c_height,tty=[],vt100_state="ground",vt100_param,vt100_ic,colors=["#000000","#770000","#007700","#777700","#0000ff","#770077","#007777","#aaaaaa","#000000","#000000","#000000"],colors_bold=["#777777","#ff0000","#00ff00","#ffff00","#0077ff","#ff00ff","#00ffff","#ffffff","#000000","#000000","#000000"],fg=7,bg=0,rev=0,bold=0;
