var a;
var cx = 0;
var cy = 0;
var ctx;

var tty_queue = "";
var conn_state = 0;

var c_width = 10;
var c_height = 16;
var t_width = c_width * 80;
var t_height = c_height * 25;

var tty = [];

function refresh() {
    a.send("R");
}

function handle_keypress(event) {
    var kbstate = 0;
    if(event.ctrlKey) a.send("K" + String.fromCharCode(event.which - 96));
    else a.send("K" + String.fromCharCode(event.which));
    event.preventDefault();
    return false;
}

function main() {
    conn_state = 1;
    document.getElementById("connect-button").innerHTML="Disconnect";
    a.onmessage = function(event) {
//	document.getElementById("log").innerHTML = "";
	for(var i = 0; i < event.data.length; i++) {
	    vt100_parse(event.data[i]);
	}
    };
    a.onclose = function(event) {
	document.getElementById("connect-button").innerHTML="Connect";
	conn_state = 0;
	setColor(0, false);
	ctx.fillRect(0, 0, t_width, t_height);
    }
    document.addEventListener('keypress', handle_keypress);
    setInterval(refresh, 10);
}

function connect() {
    if(conn_state) {
	a.close();
    } else {
	a = new WebA("ws://mc.firewiz.net/");
	a.onopen = main;
    }
}

function step_term() {
    vt100_parse(tty_queue[0]);
    tty_queue = tty_queue.substr(1);
}

var vt100_state = "ground";
var vt100_param;
var vt100_ic;

function log(s) {
    //    document.getElementById("log").innerHTML += s + "<br>";
    console.log(s);
}    

var colors = [
    "#000000", "#770000", "#007700", "#777700", "#0000ff", "#770077", "#007777", "#aaaaaa", "#000000", "#000000", "#000000"
];

var colors_bold = [
    "#777777", "#ff0000", "#00ff00", "#ffff00", "#0077ff", "#ff00ff", "#00ffff", "#ffffff", "#000000", "#000000", "#000000"
];

var fg = 7, bg = 0;
var rev = 0;
var bold = 0;

function move_curs(x, y) {
    var ox = cx;
    var oy = cy;
    cx = x;
    cy = y;
    if(cx > 79) cx = 79;
    if(cy > 24) cy = 24;
    if(cx < 0) cx = 0;
    if(cy < 0) cy = 0;
    update_term(ox, oy);
    update_term(cx, cy);
//    document.getElementById("log").innerHTML += "cursor -> " + x + ", " + y + "<br>";
}

function setColor(n, usebold) {
    if(bold && usebold)
	ctx.fillStyle = ctx.strokeStyle = colors_bold[n];
    else
	ctx.fillStyle = ctx.strokeStyle = colors[n];
}

function vt100_csi_dispatch(c) {
    var vt100_params = vt100_param.split(";");
//    document.getElementById("log").innerHTML += "ESC [ " + vt100_param + " " + c + "<br>";
    if(c == "A") {
	if(vt100_params != 0) {
	    move_curs(cx, cy - vt100_params[0]);
	} else {
	    move_curs(cx, cy - 1);
	}
    } else if(c == "C") {
	if(vt100_params != 0) {
	    move_curs(cx + vt100_params[0], cy);
	} else {
	    move_curs(cx + 1, cy);
	}
    } else if(c == "H") {
	if(vt100_params.length > 1) {
	    move_curs(vt100_params[1] - 1, vt100_params[0] - 1);
	} else {
	    move_curs(0, 0);
	}
    } else if(c == "J") {
	if(vt100_params[0] == 0) {
	} else if(vt100_params[0] == 1) {
	} else if(vt100_params[0] == 2) {
	    setColor(bg, false);
	    ctx.fillRect(0, 0, t_width, t_height);
	    setColor(fg, true);
	    tty.fill([" ", 0, 7], 0, 80 * 25);
	}
    } else if(c == "K") {
	setColor(bg, false);
	ctx.fillRect(cx * c_width, cy * c_height, t_width, c_height);
	setColor(fg, true);
	tty.fill([" ", 0, 7], cy * 80 + cx, (cy + 1) * 80);
    } else if(c == "d") {
	move_curs(cx, vt100_params[0] - 1);
    } else if(c == "h") {
	log("Set mode " + vt100_params[0]);
    } else if(c == "l") {
	log("Reset mode " + vt100_params[0]);
    } else if(c == "m") {
	if(vt100_params.length > 0) {
	    for(var i = 0; i < vt100_params.length; i++) {
		if(vt100_params[i] >= 30 && vt100_params[i] <= 39) {
		    fg = vt100_params[i] - 30;
		} else if(vt100_params[i] >= 40 && vt100_params[i] <= 49) {
		    bg = vt100_params[i] - 40;
		} else if(vt100_params[i] == "" || vt100_params[i] == 0) {
		    fg = 7;
		    bg = 0;
		    bold = 0;
		    rev = 0;
		} else if(vt100_params[i] == 1) {
		    bold = 1;
		} else if(vt100_params[i] == 7) {
		    rev = 1;
		} else {
		    log("Unknown style " + vt100_params[i]);
		}
	    }
	} else {
	    fg = 7;
	    bg = 0;
	    rev = 0;
	    bold = 0;
	}
    } else {
	log("Unknown CSI " + c + " (" + vt100_ic + " # " + vt100_param + ")");
    }
    
}

function vt100_parse(c) {
    if(vt100_state == "ground"){
	if(c == "\n") {
	    move_curs(0, cy + 1);
	} else if(c == "\r") {
	    move_curs(0, cy);
	} else if(c == "\x1b") {
	    vt100_state = "escape";
	} else if(c == "\b") {
	    move_curs(cx - 1, cy);
	} else {
	    addch(cx, cy, c);
	    var ox = cx;
	    var oy = cy;
	    cx++;
	    if(cx > 80) {
		cx = 0;
		cy++;
		if(cy > 24) cy = 0;
	    }
	    update_term(ox, oy);
	    update_term(cx, cy);
	}
    } else if(vt100_state == "escape") {
	vt100_param = vt100_ic = "";
	if(c == "[") {
	    vt100_state = "csi_entry";
	} else if(c.match(/[%(]/)) {
	    vt100_state = "esc_intermediate";
	} else {
	    vt100_state = "ground";
	}
    } else if(vt100_state == "esc_intermediate") {
	vt100_state = "ground";
    } else if(vt100_state == "csi_entry") {
	if(c.match(/[0-9;]/)) {
	    vt100_param += c;
	    vt100_state = "csi_param";
	} else if(c.match(/[ -/]/)) {
	    vt100_ic += c;
	    vt100_state = "csi_intermediate";
	} else if(c.match(/[<=>?]/)) {
	    vt100_ic += c;
	    vt100_state = "csi_param";
	} else if(c == ":") {
	    vt100_state = "csi_ignore";
	} else if(c.match(/[@-~]/)) {
	    vt100_csi_dispatch(c);
	    vt100_state = "ground";
	} else {
	    vt100_state = "ground";
	}
    } else if(vt100_state == "csi_intermediate") {
	if(c.match(/[ -/]/)) {
	    vt100_ic += c;
	} else if(c.match(/[@-~]/)) {
	    vt100_csi_dispatch(c);
	    vt100_state = "ground";
	} else {
	    vt100_state = "ground";
	}
    } else if(vt100_state == "csi_param") {
	if(c.match(/[0-9;]/)) {
	    vt100_param += c;
	} else if(c.match(/[:<-?]/)) {
	    vt100_state = "csi_ignore";
	} else if(c.match(/[@-~]/)) {
	    vt100_csi_dispatch(c);
	    vt100_state = "ground";
	} else {
	    vt100_state = "ground";
	}
    } else if(vt100_state == "csi_ignore") {
	if(c.match(/[@-~]/)) {
	    vt100_state = "ground";
	}
    } else {
	vt100_state = "ground";
    }
}

function update_term(x, y) {
    if(x < 0 || x > 79 || y < 0 || y > 79) return;
    var cd = tty[x + y * 80];
    setColor(cd[1], false);
    ctx.fillRect(x * c_width, y * c_height, c_width, c_height);
    setColor(cd[2], true);
    ctx.fillText(cd[0], x * c_width, y * c_height + (c_height * 0.75));
    if(x === cx && y === cy)
	ctx.fillRect(x * c_width, y * c_height + (c_height * 0.8), c_width, 1);
}    

function addch(x, y, c) {
    if(rev)
	tty[x + y * 80] = [c, fg, bg];
    else
	tty[x + y * 80] = [c, bg, fg];
    update_term(x, y);
//    document.getElementById("log").innerHTML += c + " -> " + x + ", " + y + " <br>";
}

function tty_init() {
    var c = document.getElementById("term");
    ctx = c.getContext("2d");
    ctx.font = "16px monospace";
    setColor(bg);
    ctx.fillRect(0, 0, t_width, t_height);
    setColor(fg);
    for(var i = 0; i < 80 * 25; i++) {
	tty[i] = [" ", 0, 7];
    }
}
